#!./gluthost
MOAISim.openWindow("Earnest Money", 1280, 720)

viewport = MOAIViewport.new()
viewport:setSize(1280, 720)
viewport:setScale(1280, -720)
viewport:setOffset(-1, 1)

require "classes/game"
require "classes/vim"

vim = Vim.new()

require "assets/costumes/costumes"
require "assets/sheets/_layout"
require "assets/rooms/rooms"

Room.getRoom("inside"):load()

local function keyCallback(key, down)
    if not down then return end

    if key == 27 then
        vim:clear(true)
    elseif key == 13 then
        vim:send()
    elseif key == 8 then
        vim:backspace()
    else
        vim:addChar(string.char(key))
    end
    
    game.updateBuffer(vim:getBufferText())
end

vim:buf("normal", "^q$", function() os.exit() end)
vim:cmd("global", "l|oad", Room.change)
vim:cmd("global", "q|uit", os.exit)

local mouse = { x = 0, y = 0 }
game.export("getMouse", function() return mouse.x, mouse.y end )

local function pointerCallback(x, y)
    mouse.x = x
    mouse.y = y
    game.setCursorPos(x, y)
end

local function hoverCallback()
    while true do
        Sheet.dispatchHover(mouse.x, mouse.y)
        
        Sheet.dispatchBeforeDraw()
        coroutine.yield()
        Sheet.dispatchAfterDraw()
    end
end

local function clickCallback(down)
    Sheet.dispatchClick(mouse.x, mouse.y, down)
end

local function rClickCallback(down)
    Sheet.dispatchRClick(mouse.x, mouse.y, down)
end

local routine = MOAICoroutine.new()
routine:run(hoverCallback)

MOAIInputMgr.device.pointer:setCallback(pointerCallback)
MOAIInputMgr.device.mouseLeft:setCallback(clickCallback)
MOAIInputMgr.device.mouseRight:setCallback(rClickCallback)
MOAIInputMgr.device.keyboard:setCallback(keyCallback)

while io.read(0) do
    local char = io.read(1)
    
    if char == "\n" then
        vim:send()
    else
        vim:addChar(char)
    end
end

game.updateBuffer(vim:getBufferText())
